const _e="/api";async function A(t,e="GET",o=null){try{const s={method:e,headers:{}};o&&(s.headers["Content-Type"]="application/json",s.body=JSON.stringify(o));const l=await(await fetch(`${_e}${t}`,s)).json();return l.success||(console.error("API Error:",l.error),w(l.error||"API request failed","error")),l}catch(s){return console.error("Network error:",s),w("Network error","error"),{success:!1,error:s.message}}}async function Fe(){const t=await A("/timer/start","POST");if(t.success)w("Game started","success"),R();else{if(t.validation_errors&&t.validation_errors.length>0){const o=t.validation_errors.join(", ");console.warn("Validation errors:",o),w(`Cannot start game: ${o}`,"error"),(o.includes("roster")||o.includes("players"))&&(console.warn("Clearing scheduled start due to roster validation failure"),r.scheduledStartTs=null,E())}else w(t.error||"Failed to start game","error");throw new Error(t.error||"Failed to start game")}}async function Le(){(await A("/timer/pause","POST")).success&&(w("Game paused","success"),R())}async function Ie(){(await A("/timer/halftime","POST")).success&&(w("Halftime started","success"),R())}async function Ae(t){(await A("/timer/stoppage","POST",{seconds:t})).success&&(w(`Added ${t}s stoppage time`,"success"),R())}async function Be(t,e=null,o=!1){(await A("/timer/adjustment","POST",{seconds:t,period_index:e,apply_to_all:o})).success&&(w(`Added ${t}s time adjustment`,"success"),R())}async function ke(){try{const t=await fetch("/api/analytics/export",{method:"GET"});if(!t.ok)throw new Error("Failed to export report");const e=t.headers.get("content-disposition");let o="game_report.csv";if(e){const i=e.match(/filename="(.+)"/);i&&(o=i[1])}const s=await t.blob(),a=URL.createObjectURL(s),l=document.createElement("a");l.href=a,l.download=o,l.style.display="none",document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(a),w("Report exported successfully","success")}catch(t){console.error("Export failed:",t),w("Failed to export report","error")}}async function R(){const t=await A("/state");t.success&&(De(t),M())}function De(t){const e=t.game_state,o=t.players;r.paused=e.paused,r.gameStartTs=e.game_started?Date.now()/1e3-e.elapsed_seconds:null,r.periodCount=e.period_count,r.players=o.map(s=>({name:s.name,number:s.number,preferred:s.preferred_positions,totalSec:s.total_seconds,onField:s.on_field,position:s.position,stintStart:s.on_field&&!e.paused?Date.now()/1e3:null}))}function w(t,e="info"){const o=document.createElement("div");o.className=`notification ${e}`,o.textContent=t,o.style.cssText=`
    position: fixed; top: 20px; right: 20px; z-index: 1000;
    padding: 12px 20px; border-radius: 8px; color: white;
    background: ${e==="success"?"#24c88b":e==="error"?"#ff6b6b":"#4ea1ff"};
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
  `,document.body.appendChild(o),setTimeout(()=>{o.style.opacity="0",o.style.transform="translateY(-20px)",setTimeout(()=>document.body.removeChild(o),300)},3e3)}const oe=60,je=10.5,Re={1:"Full Time",2:"Half",3:"Third",4:"Quarter"},Ne={GK:"Goalkeeper",DF:"Defender",MF:"Midfielder",ST:"Striker"},de=120;function se(){if(f&&f.positions&&f.positions.length>0)return f.positions.map(o=>{const s=o.position_code;return s.includes("GK")||s==="GOALKEEPER"?"GK":s.includes("LB")||s.includes("RB")||s.includes("CB")||s.includes("DF")||s==="DEFENDER"?"DF":s.includes("LM")||s.includes("RM")||s.includes("CM")||s.includes("CAM")||s.includes("CDM")||s.includes("MF")||s==="MIDFIELDER"?"MF":s.includes("LW")||s.includes("RW")||s.includes("ST")||s.includes("CF")||s.includes("FOR")||s==="FORWARD"?"ST":"MF"});const t=r.fieldSize||11,e=["GK"];return t===7?e.push("DF","DF","MF","MF","MF","ST"):t===9?e.push("DF","DF","DF","MF","MF","ST","ST","ST"):t===10?e.push("DF","DF","DF","MF","MF","MF","ST","ST","ST"):e.push("DF","DF","DF","MF","MF","MF","ST","ST","ST","ST"),e}let r={players:[],fieldSize:11,gameStartTs:null,paused:!0,breakActive:!1,halftimeEndTs:null,scheduledStartTs:null,elapsedAdjustment:0,gameLengthSec:oe*60,periodCount:2,periodElapsed:[],periodAdjust:[],periodStoppage:[],currentPeriodIndex:0,periodStartTs:null};function Ge(t){const e=t%100;if(e>=11&&e<=13)return`${t}th`;const o=t%10;return`${t}${o===1?"st":o===2?"nd":o===3?"rd":"th"}`}function ee(t,e){const o=Re[e]||"Period";return e<=1?o:`${Ge(t)} ${o}`}function T(){const t=Math.max(1,r.periodCount|0);r.periodCount=t;const e=o=>(Array.isArray(o)||(o=[]),o.length<t?o.concat(Array(t-o.length).fill(0)):o.length>t?o.slice(0,t):o);r.periodElapsed=e(r.periodElapsed),r.periodAdjust=e(r.periodAdjust),r.periodStoppage=e(r.periodStoppage),r.currentPeriodIndex>=t&&(r.currentPeriodIndex=t-1)}function re(){r.gameLengthSec=Number(r.gameLengthSec||oe*60),r.periodCount=Number(r.periodCount||2),r.elapsedAdjustment=Number(r.elapsedAdjustment||0),r.fieldSize=Number(r.fieldSize||11),typeof r.currentPeriodIndex!="number"&&(r.currentPeriodIndex=0),typeof r.periodStartTs!="number"&&(r.periodStartTs=null),r.breakActive=!!r.breakActive,T(),typeof n<"u"&&n.fieldSizeSelect&&(n.fieldSizeSelect.value=r.fieldSize)}function N(){return T(),r.periodAdjust.slice(0,r.periodCount).reduce((t,e)=>t+(e|0),0)}function J(){r.elapsedAdjustment=N()}function j(){return T(),r.periodStoppage.slice(0,r.periodCount).reduce((t,e)=>t+(e|0),0)}function ue(){return Math.max(0,r.gameLengthSec+j()+N())}function pe(){const t=Math.max(1,r.players.length);return ue()/t}function Oe(t=!0){T();let e=r.periodElapsed.slice(0,r.periodCount).reduce((o,s)=>o+(s|0),0);return t&&r.periodStartTs&&!r.paused&&!r.breakActive&&(e+=Math.max(0,S()-r.periodStartTs)),e===0&&r.gameStartTs&&(e=Math.max(0,S()-r.gameStartTs)),e}function me(){return Oe()+N()+j()}function He(t){T();const e=r.periodCount,o=Math.floor(r.gameLengthSec/e),s=r.gameLengthSec%e;return o+(t<s?1:0)+(r.periodAdjust[t]|0)+(r.periodStoppage[t]|0)}function Ue(t){const e=r.periodCount,o=Math.floor(r.gameLengthSec/e),s=r.gameLengthSec%e;return o+(t<s?1:0)}function ze(t){const e=He(t),o=r.periodElapsed[t]+(t===r.currentPeriodIndex&&r.periodStartTs&&!r.paused&&!r.breakActive?Math.max(0,S()-r.periodStartTs):0);return Math.max(0,e-o)}console.log("[DEBUG] Starting UI initialization...");let n={btnSetup:document.getElementById("btnSetup"),btnLineup:document.getElementById("btnLineup"),btnGame:document.getElementById("btnGame"),btnReports:document.getElementById("btnReports"),btnPlayers:document.getElementById("btnPlayers"),btnFormations:document.getElementById("btnFormations"),viewSetup:document.getElementById("viewSetup"),viewLineup:document.getElementById("viewLineup"),viewGame:document.getElementById("viewGame"),viewReports:document.getElementById("viewReports"),viewPlayers:document.getElementById("viewPlayers"),viewFormations:document.getElementById("viewFormations"),rosterInput:document.getElementById("rosterInput"),fieldSizeSelect:document.getElementById("fieldSizeSelect"),btnExample:document.getElementById("btnExample"),btnLoadRoster:document.getElementById("btnLoadRoster"),btnSave:document.getElementById("btnSave"),btnLoad:document.getElementById("btnLoad"),btnClear:document.getElementById("btnClear"),fileLoad:document.getElementById("fileLoad"),scheduledHHMM:document.getElementById("scheduledHHMM"),btnSetSchedule:document.getElementById("btnSetSchedule"),scheduledLabel:document.getElementById("scheduledLabel"),btnStart:document.getElementById("btnStart"),btnPause:document.getElementById("btnPause"),btnHalftime:document.getElementById("btnHalftime"),btnEndHalftime:document.getElementById("btnEndHalftime"),formatMinutes:document.getElementById("formatMinutes"),formatPeriods:document.getElementById("formatPeriods"),btnApplyFormat:document.getElementById("btnApplyFormat"),adjustKind:document.getElementById("adjustKind"),adjustPeriod:document.getElementById("adjustPeriod"),adjustSeconds:document.getElementById("adjustSeconds"),adjustAll:document.getElementById("adjustAll"),btnApplyManual:document.getElementById("btnApplyManual"),slotList:document.getElementById("slotList"),rosterTable:document.querySelector("#rosterTable tbody"),assignTable:document.querySelector("#assignTable tbody"),btnClearAssign:document.getElementById("btnClearAssign"),btnStartGame:document.getElementById("btnStartGame"),clockLabel:document.getElementById("clockLabel"),statusLabel:document.getElementById("statusLabel"),periodPill:document.getElementById("periodPill"),metaPill:document.getElementById("metaPill"),halfLabel:document.getElementById("halfLabel"),schedLabel:document.getElementById("schedLabel"),gStart:document.getElementById("gStart"),gPause:document.getElementById("gPause"),gHalf:document.getElementById("gHalf"),gSave:document.getElementById("gSave"),periodTable:document.querySelector("#periodTable tbody"),onFieldTable:document.querySelector("#onFieldTable tbody"),rosterGameTable:document.querySelector("#rosterGameTable tbody"),btnQueue:document.getElementById("btnQueue"),btnClearQueue:document.getElementById("btnClearQueue"),btnCommit:document.getElementById("btnCommit"),queueList:document.getElementById("queueList"),btnReportExport:document.getElementById("btnReportExport"),reportSummary:document.getElementById("reportSummary"),reportDetail:document.getElementById("reportDetail"),reportDistribution:document.getElementById("reportDistribution"),reportTargets:document.getElementById("reportTargets"),reportElapsed:document.getElementById("reportElapsed"),reportTable:document.querySelector("#reportTable tbody"),reportNote:document.getElementById("reportNote"),playersTable:document.querySelector("#playersTable tbody"),playerDetails:document.getElementById("playerDetails"),btnAddPlayer:document.getElementById("btnAddPlayer"),btnEditPlayer:document.getElementById("btnEditPlayer"),btnDeletePlayer:document.getElementById("btnDeletePlayer"),btnImportPlayers:document.getElementById("btnImportPlayers"),btnExportPlayers:document.getElementById("btnExportPlayers"),btnPlayerStats:document.getElementById("btnPlayerStats"),btnAttendance:document.getElementById("btnAttendance"),formationSelect:document.getElementById("formationSelect"),formationName:document.getElementById("formationName"),formationType:document.getElementById("formationType"),formationDescription:document.getElementById("formationDescription"),btnNewFormation:document.getElementById("btnNewFormation"),btnFromTemplate:document.getElementById("btnFromTemplate"),btnDeleteFormation:document.getElementById("btnDeleteFormation"),btnSaveFormation:document.getElementById("btnSaveFormation"),btnAutoAssign:document.getElementById("btnAutoAssign"),btnClearAssignments:document.getElementById("btnClearAssignments"),btnSuggestFormation:document.getElementById("btnSuggestFormation"),fieldContainer:document.getElementById("fieldContainer"),fieldMarkings:document.getElementById("fieldMarkings"),formationPositions:document.getElementById("formationPositions"),formationInfo:document.getElementById("formationInfo"),positionAssignments:document.getElementById("positionAssignments"),templateModal:document.getElementById("templateModal"),templateList:document.getElementById("templateList"),templateFormationName:document.getElementById("templateFormationName"),btnCancelTemplate:document.getElementById("btnCancelTemplate"),btnCreateFromTemplate:document.getElementById("btnCreateFromTemplate")};console.log("[DEBUG] UI object created");re();console.log("[DEBUG] State normalized");let I=null,v=null,P=null,_=[],D=null,Z=null;function S(){return Math.floor(Date.now()/1e3)}function g(t){t=Math.max(0,t|0);const e=Math.floor(t/60),o=t%60;return`${String(e).padStart(2,"0")}:${String(o).padStart(2,"0")}`}function z(t){return(t>=0?"+":"-")+g(Math.abs(t))}function E(){J(),localStorage.setItem("sideline_state",JSON.stringify(r))}function qe(){const t=localStorage.getItem("sideline_state");if(t)try{r=JSON.parse(t)}catch(e){console.warn("Failed to parse saved state",e)}re(),J()}function Ke(){r={players:[],fieldSize:11,gameStartTs:null,paused:!0,breakActive:!1,halftimeEndTs:null,scheduledStartTs:null,elapsedAdjustment:0,gameLengthSec:oe*60,periodCount:2,periodElapsed:[],periodAdjust:[],periodStoppage:[],currentPeriodIndex:0,periodStartTs:null},re(),_=[],v=null,P=null,I=null,E(),H()}function te(t,e=pe()){const o=t-e;return o<=-de?"under":o>=de?"over":"ok"}function q(t){return t.onField&&t.stintStart?S()-t.stintStart:0}function K(t){return(t.totalSec|0)+q(t)}function We(t){if(!t.length)return 0;const e=t.slice().sort((s,a)=>s-a),o=Math.floor(e.length/2);return e.length%2===0?(e[o-1]+e[o])/2:e[o]}function Je(t){if(t==null)return"";const e=String(t);return/[",\n]/.test(e)?`"${e.replace(/"/g,'""')}"`:e}function Qe(t){const e=[],o=new Date(t.generatedTs*1e3).toISOString();e.push(["Sideline Timekeeper Report"]),e.push(["Generated",o]),e.push(["Roster Size",t.rosterSize]),e.push(["Elapsed Seconds",Math.round(t.elapsed)]),e.push(["Regulation Seconds",Math.round(t.regulationSeconds)]),e.push(["Stoppage Seconds",Math.round(t.stoppage)]),e.push(["Adjustment Seconds",Math.round(t.adjustments)]),e.push(["Target Seconds Total",Math.round(t.totalTarget)]),e.push(["Target Seconds Per Player",Math.round(t.perPlayerRounded)]),e.push(["Average Seconds",Math.round(t.average*100)/100]),e.push(["Median Seconds",Math.round(t.median*100)/100]),e.push(["Minimum Seconds",Math.round(t.min)]),e.push(["Maximum Seconds",Math.round(t.max)]);const s=t.fairnessCounts||{under:0,ok:0,over:0};return e.push(["Players Under Target",s.under||0]),e.push(["Players On Target",s.ok||0]),e.push(["Players Over Target",s.over||0]),e.push([]),e.push(["Name","Number","Preferred Positions","On Field","Position","Total Seconds","Active Stint Seconds","Cumulative Seconds","Target Seconds","Delta Seconds","Bench Seconds","Target Share (%)","Fairness"]),t.rows.forEach(a=>{e.push([a.name,a.number,a.preferredList.join(", "),a.onField?"yes":"no",a.position,a.totalSeconds,a.activeSeconds,a.cumulativeSeconds,a.targetSeconds,a.deltaSeconds,a.benchSeconds,Math.round(a.targetSharePercent*100)/100,a.fairness])}),e.map(a=>a.map(Je).join(",")).join(`
`)+`
`}function fe(){T();const t=r.players.slice();if(!t.length)return Z=null,null;const e=S(),o=me(),s=ue(),a=pe(),l=Math.round(a),i=j(),d=N(),p=r.gameLengthSec,c=t.map(K),u=c.length?c.reduce((h,C)=>h+C,0)/c.length:0,m=We(c),y=c.length?Math.min(...c):0,x=c.length?Math.max(...c):0,$={under:0,ok:1,over:2},B=t.map(h=>{const C=(h.preferred||"").split(",").map(X=>X.trim().toUpperCase()).filter(X=>X.length),k=K(h),Ce=Math.round(k-a),Me=te(k,a),ve=a>0?k/a*100:0,Pe=h.onField?`On Field${h.position?` (${h.position})`:""}`:"Bench",we=Math.max(0,o-k),$e=q(h);return{name:h.name,number:h.number||"",preferredList:C,preferredDisplay:C.join(", "),onField:!!h.onField,position:h.position||"",totalSeconds:Math.max(0,h.totalSec|0),activeSeconds:$e,cumulativeSeconds:k,targetSeconds:l,deltaSeconds:Ce,benchSeconds:we,targetSharePercent:ve,fairness:Me,status:Pe}});B.sort((h,C)=>$[h.fairness]!==$[C.fairness]?$[h.fairness]-$[C.fairness]:h.deltaSeconds!==C.deltaSeconds?h.deltaSeconds-C.deltaSeconds:h.name.localeCompare(C.name));const Y={under:0,ok:0,over:0};return B.forEach(h=>{const C=h.fairness;Y[C]=(Y[C]||0)+1}),Z={generatedTs:e,rosterSize:t.length,elapsed:o,totalTarget:s,perPlayerTarget:a,perPlayerRounded:l,stoppage:i,adjustments:d,regulationSeconds:p,average:u,median:m,min:y,max:x,rows:B,fairnessCounts:Y},Z}function Ve(){const t=fe();if(!t){alert("Add players before exporting analytics.");return}const e=Qe(t),o=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(o),a=new Date(t.generatedTs*1e3).toISOString().replace(/[:.]/g,"-"),l=document.createElement("a");l.href=s,l.download=`sideline_report_${a}.csv`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(s)}function F(t){const e={setup:n.viewSetup,players:n.viewPlayers,formations:n.viewFormations,lineup:n.viewLineup,game:n.viewGame,reports:n.viewReports};Object.entries(e).forEach(([s,a])=>{a&&a.classList.toggle("hidden",t!==s)});const o={setup:n.btnSetup,players:n.btnPlayers,formations:n.btnFormations,lineup:n.btnLineup,game:n.btnGame,reports:n.btnReports};Object.entries(o).forEach(([s,a])=>{a&&a.classList.toggle("primary",t===s)})}console.log("[DEBUG] UI object created, btnSetup=",n.btnSetup);console.log("[DEBUG] Attaching event handlers...");n.btnSetup.onclick=()=>{console.log("[DEBUG] Setup clicked"),F("setup")};n.btnPlayers.onclick=()=>{console.log("[DEBUG] Players clicked"),F("players"),L()};n.btnFormations.onclick=()=>{console.log("[DEBUG] Formations clicked"),F("formations"),O()};n.btnLineup.onclick=()=>{console.log("[DEBUG] Lineup clicked"),F("lineup"),ye()};n.btnGame.onclick=()=>{console.log("[DEBUG] Game clicked"),F("game"),M()};n.btnReports.onclick=()=>{console.log("[DEBUG] Reports clicked"),F("reports"),Q()};console.log("[DEBUG] Event handlers attached successfully");n.btnReportExport&&(n.btnReportExport.onclick=Ve);n.btnAddPlayer&&(n.btnAddPlayer.onclick=tt);n.btnEditPlayer&&(n.btnEditPlayer.onclick=nt);n.btnDeletePlayer&&(n.btnDeletePlayer.onclick=ot);n.btnImportPlayers&&(n.btnImportPlayers.onclick=at);n.btnExportPlayers&&(n.btnExportPlayers.onclick=it);n.btnPlayerStats&&(n.btnPlayerStats.onclick=lt);n.btnAttendance&&(n.btnAttendance.onclick=dt);n.btnEditPlayer&&(n.btnEditPlayer.disabled=!0);n.btnDeletePlayer&&(n.btnDeletePlayer.disabled=!0);n.btnPlayerStats&&(n.btnPlayerStats.disabled=!0);n.btnAttendance&&(n.btnAttendance.disabled=!0);n.btnNewFormation&&(n.btnNewFormation.onclick=yt);n.btnFromTemplate&&(n.btnFromTemplate.onclick=ht);n.btnDeleteFormation&&(n.btnDeleteFormation.onclick=St);n.btnSaveFormation&&(n.btnSaveFormation.onclick=Et);n.btnAutoAssign&&(n.btnAutoAssign.onclick=xt);n.btnClearAssignments&&(n.btnClearAssignments.onclick=Tt);n.btnSuggestFormation&&(n.btnSuggestFormation.onclick=Ct);n.formationSelect&&(n.formationSelect.onchange=le);n.btnCancelTemplate&&(n.btnCancelTemplate.onclick=()=>n.templateModal.classList.add("hidden"));n.btnCreateFromTemplate&&(n.btnCreateFromTemplate.onclick=bt);n.btnExample.onclick=()=>{const t=[];for(let e=1;e<=17;e++){const o=e<=4?"ST":e<=8?"MF":e<=14?"DF":"GK";t.push(`Player ${e},${String(e).padStart(2,"0")},${o}`)}n.rosterInput.value=t.join(`
`)};n.btnLoadRoster.onclick=async()=>{const t=n.rosterInput.value.split(`
`).map(l=>l.trim()).filter(Boolean),e=[],o=new Set;for(const l of t){const i=l.split(",").map(u=>u.trim()).filter(u=>u.length),d=i[0];if(!d||o.has(d))continue;o.add(d);const p=i[1]||"",c=i[2]||"";e.push({name:d,number:p,preferred:c,totalSec:0,onField:!1,position:null,stintStart:null})}const s=parseInt(n.fieldSizeSelect.value),a=Math.max(s-2,7);if(e.length<a){alert(`Need at least ${a} players for ${s}v${s} format.`);return}r.players=e,r.fieldSize=s,E();try{const l=e.map(p=>({name:p.name,number:p.number||"",preferred:p.preferred||""})),i=await fetch("/api/roster",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({players:l,field_size:s})}),d=await i.json();i.ok&&d.success?alert(`Roster loaded and synced with server! ${d.message}`):(console.error("Server sync failed:",d.error||i.statusText),alert("Roster loaded locally, but server sync failed. Players page may not show data."))}catch(l){console.error("Failed to sync with server:",l),alert("Roster loaded locally, but server sync failed. Players page may not show data.")}};n.btnSave.onclick=()=>{const t=JSON.parse(JSON.stringify(r)),e=S();t.players.forEach(a=>{a.onField&&a.stintStart&&(a.totalSec+=e-a.stintStart)});const o=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=document.createElement("a");s.href=URL.createObjectURL(o),s.download=`sideline_${new Date().toISOString().replace(/[:.]/g,"-")}.json`,s.click()};n.btnLoad.onclick=()=>n.fileLoad.click();n.fileLoad.onchange=async t=>{const e=t.target.files[0];if(!e)return;const o=await e.text();try{const s=JSON.parse(o);if(!Array.isArray(s.players))throw new Error("Invalid file");r=s,E(),H(),alert("Game loaded.")}catch(s){alert("Failed to load: "+s.message)}finally{t.target.value=""}};n.btnClear.onclick=()=>{confirm("Clear roster and game state?")&&Ke()};n.btnSetSchedule.onclick=()=>{const t=n.scheduledHHMM.value.trim();if(!t||!/^\d{1,2}:\d{2}$/.test(t)){alert("Use HH:MM (24-hour)");return}const[e,o]=t.split(":").map(Number),s=new Date;s.setHours(e,o,0,0),r.scheduledStartTs=Math.floor(s.getTime()/1e3),E(),Ee()};n.btnStart.onclick=ae;n.btnPause.onclick=ie;n.btnHalftime.onclick=be;n.btnEndHalftime.onclick=Ye;n.btnApplyFormat.onclick=()=>{const t=parseInt(n.formatMinutes.value,10),e=parseInt(n.formatPeriods.value,10);if(Number.isNaN(t)||Number.isNaN(e)){alert("Enter minutes and period count.");return}if(t<10||t>120){alert("Minutes must be between 10 and 120.");return}if(e<1||e>4){alert("Periods must be between 1 and 4.");return}if(t*60<e*60){alert("Provide at least one minute per period.");return}if(r.gameStartTs){alert("Stop/reset the game before changing the timer format.");return}r.gameLengthSec=t*60,r.periodCount=e,T(),r.periodElapsed=Array(e).fill(0),r.periodAdjust=Array(e).fill(0),r.periodStoppage=Array(e).fill(0),r.currentPeriodIndex=0,r.periodStartTs=null,J(),E(),H()};n.adjustKind.onchange=()=>{const t=n.adjustKind.value==="stoppage";n.adjustAll.disabled=t,t&&(n.adjustAll.checked=!1)};n.btnApplyManual.onclick=()=>{T();const t=n.adjustKind.value,e=parseInt(n.adjustPeriod.value,10),o=parseInt(n.adjustSeconds.value,10);if(Number.isNaN(e)){alert("Select a period.");return}if(Number.isNaN(o)){alert("Enter seconds (integer).");return}if(t==="adjustment"){if(o===0){alert("Enter a non-zero adjustment.");return}if(n.adjustAll.checked)for(let s=0;s<r.periodCount;s++)r.periodAdjust[s]+=o;else r.periodAdjust[e]+=o;J()}else{if(o<=0){alert("Stoppage time must be positive seconds.");return}r.periodStoppage[e]=Math.max(0,r.periodStoppage[e]+o)}n.adjustSeconds.value="",E(),H()};function ye(){const t=se();n.slotList.innerHTML="",t.forEach((o,s)=>{const a=document.createElement("li");a.style.padding="6px 8px",a.style.border="1px solid var(--line)",a.style.borderRadius="8px",a.style.marginBottom="6px",a.style.cursor="pointer",a.dataset.index=s,a.innerHTML=`<b>${s+1}. ${o}</b> – ${Ne[o]}`,a.onclick=()=>{I=s,W()},n.slotList.appendChild(a)}),W(),n.rosterTable.innerHTML="";const e=new Set;Array.from(n.assignTable.querySelectorAll("tbody tr td:nth-child(2)")).forEach(o=>{e.add(o.textContent)}),r.players.slice().sort((o,s)=>(o.number||"").localeCompare(s.number||"")||o.name.localeCompare(s.name)).forEach(o=>{const s=document.createElement("tr");s.innerHTML=`<td>${o.name}</td><td>${o.number||""}</td><td>${(o.preferred||"").toUpperCase()}</td>`,e.has(o.name)?(s.classList.add("player-used"),s.onclick=()=>alert(`${o.name} is already assigned to a position.`)):(s.style.cursor="pointer",s.onclick=()=>he(o.name)),n.rosterTable.appendChild(s)})}function W(){const t=new Set;Array.from(n.assignTable.querySelectorAll("tbody tr")).forEach(e=>{if(e.children.length>=2){const o=e.children[0].textContent,s=parseInt(o.split(".")[0])-1;t.add(s)}}),Array.from(n.slotList.children).forEach((e,o)=>{e.classList.remove("slot-filled"),t.has(o)&&e.classList.add("slot-filled"),o===I?e.style.background="#0c1732":t.has(o)||(e.style.background="transparent")})}function ge(){const t=new Set;Array.from(n.assignTable.querySelectorAll("tbody tr td:nth-child(2)")).forEach(e=>{t.add(e.textContent)}),Array.from(n.rosterTable.querySelectorAll("tr")).forEach(e=>{const o=e.children[0].textContent;e.classList.remove("player-used"),t.has(o)?(e.classList.add("player-used"),e.onclick=()=>alert(`${o} is already assigned to a position.`),e.style.cursor="not-allowed"):(e.style.cursor="pointer",e.onclick=()=>he(o))})}function he(t){if(I===null){alert("Select a slot on the left first.");return}if(Array.from(n.assignTable.querySelectorAll("tbody tr td:nth-child(2)")).map(i=>i.textContent).includes(t)){alert("Player already assigned.");return}const o=se(),s=`${I+1}. ${o[I]}`,a=Array.from(n.assignTable.querySelectorAll("tbody tr"));for(const i of a)i.children[0].textContent===s&&i.remove();const l=document.createElement("tr");l.innerHTML=`<td>${s}</td><td>${t}</td>`,n.assignTable.appendChild(l),W(),ge()}n.btnClearAssign.onclick=()=>{n.assignTable.innerHTML="",W(),ge()};n.btnStartGame.onclick=async()=>{console.log("[DEBUG] Start Game button clicked");try{n.btnStartGame.disabled=!0,n.btnStartGame.textContent="Validating...",console.log("[DEBUG] Starting validation...");const t={},e=Array.from(n.assignTable.querySelectorAll("tbody tr"));if(e.length===0){U("No player assignments found. Please assign players to positions first.");return}e.forEach(u=>{const m=u.children[0].textContent,y=m.split(".")[1].trim().split(" ")[0],x=u.children[1].textContent;if(!x||x.trim()==="")throw new Error(`Position ${m} is not assigned to any player`);t[y]=(t[y]||[]).concat([x])});const o=se();console.log("[DEBUG] Required slots:",o);const s={GK:0,DF:0,MF:0,ST:0};o.forEach(u=>{s[u]=(s[u]||0)+1}),console.log("[DEBUG] Calculated needs:",s);const a={GK:(t.GK||[]).length,DF:(t.DF||[]).length,MF:(t.MF||[]).length,ST:(t.ST||[]).length};console.log("[DEBUG] Got assignments:",a);const l=[],i=[];for(const[u,m]of Object.entries(s)){if(m===0)continue;const y=a[u];y<m?l.push(`Need ${m} ${u} player(s), only have ${y}`):y>m&&l.push(`Too many ${u} players: need ${m}, have ${y}`)}const d=[];for(const u of Object.values(t))d.push(...u);new Set(d).size!==d.length&&l.push("Same player assigned to multiple positions");const c=r.players.map(u=>u.name);for(const u of d)c.includes(u)||l.push(`Player "${u}" not found in roster`);for(const[u,m]of Object.entries(t))for(const y of m){const x=r.players.find($=>$.name===y);x&&x.preferred&&(x.preferred.split(",").map(B=>B.trim().toUpperCase()).includes(u)||i.push(`${y} is playing ${u} but prefers ${x.preferred}`))}if(l.length>0){const u=`Cannot start game - lineup validation failed:

`+l.join(`
`)+`

Please fix these issues and try again.`;U(u);return}if(i.length>0){const u=`Starting game with the following warnings:

`+i.join(`
`)+`

Do you want to continue?`;if(!confirm(u))return}n.btnStartGame.textContent="Starting Game...";try{const m=await(await fetch("/api/timer/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({formation_name:r.currentFormation||null})})).json();if(!m.success){let y=m.error||"Failed to start game";m.validation_errors&&m.validation_errors.length>0&&(y+=`

Validation errors:
`+m.validation_errors.join(`
`)),m.suggestions&&m.suggestions.length>0&&(y+=`

Suggestions:
`+m.suggestions.join(`
`)),U(y);return}if(m.warnings&&m.warnings.length>0){const y=`Game started with warnings:
`+m.warnings.join(`
`);console.warn(y)}await ce(t)}catch(u){console.warn("API game start failed, falling back to local:",u),await ce(t)}}catch(t){console.error("Error starting game:",t),U(`Failed to start game: ${t.message}`)}finally{n.btnStartGame.disabled=!1,n.btnStartGame.textContent="Start Game"}};function U(t){const e=document.createElement("div");e.style.cssText=`
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background: var(--over); color: white; padding: 16px 24px;
    border-radius: 8px; z-index: 10000; max-width: 80%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  `,e.innerHTML=`
    <strong>⚠️ Lineup Validation Error</strong><br>
    <div style="margin-top: 8px; white-space: pre-line;">${t}</div>
    <button onclick="this.parentElement.remove()" style="
      margin-top: 12px; background: rgba(255,255,255,0.2); 
      border: 1px solid rgba(255,255,255,0.3); color: white;
      padding: 4px 12px; border-radius: 4px; cursor: pointer;
    ">Close</button>
  `,document.body.appendChild(e),setTimeout(()=>{e.parentElement&&e.remove()},1e4)}async function ce(t){const e=S();r.players.forEach(a=>{a.onField=!1,a.position=null,a.stintStart=null});for(const[a,l]of Object.entries(t))for(const i of l){const d=r.players.find(p=>p.name===i);d&&(d.onField=!0,d.position=a,d.stintStart=e)}const o=!r.gameStartTs;o&&(r.gameStartTs=e),T(),o&&(r.currentPeriodIndex=0,r.periodElapsed=Array(r.periodCount).fill(0)),r.periodStartTs=e,r.breakActive=!1,r.paused=!1,E(),F("game"),M(),G();const s=document.createElement("div");s.style.cssText=`
    position: fixed; top: 20px; right: 20px;
    background: var(--ok); color: white; padding: 12px 20px;
    border-radius: 8px; z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  `,s.innerHTML="✅ Game started successfully!",document.body.appendChild(s),setTimeout(()=>s.remove(),3e3)}function ae(){const t=r.scheduledStartTs!==null;t&&(console.log("Clearing scheduled start time before attempting game start"),r.scheduledStartTs=null,E()),Fe().catch(e=>{if(console.warn("API start game failed:",e),t){w("Cannot start game automatically - check lineup and try manual start","warning");return}T();const o=S();!r.gameStartTs&&(r.gameStartTs=o,r.currentPeriodIndex=0,r.periodElapsed=Array(r.periodCount).fill(0)),(!r.periodStartTs||r.paused||r.breakActive)&&(r.periodStartTs=o),r.breakActive=!1,r.paused=!1,r.players.forEach(a=>{a.onField&&!a.stintStart&&(a.stintStart=o)}),E(),M(),G()})}function ie(){Le().catch(()=>{if(r.paused)return;const t=S();T(),r.periodStartTs&&(r.periodElapsed[r.currentPeriodIndex]+=Math.max(0,t-r.periodStartTs),r.periodStartTs=null),r.players.forEach(e=>{e.onField&&e.stintStart&&(e.totalSec+=t-e.stintStart,e.stintStart=null)}),r.paused=!0,E(),M(),Xe()})}function be(){Ie().catch(()=>{ie(),r.breakActive=!0,r.halftimeEndTs=S()+Math.floor(je*60),E(),M(),G()})}function Ye(){T(),r.breakActive=!1,r.halftimeEndTs=null,r.currentPeriodIndex<r.periodCount-1&&(r.currentPeriodIndex+=1);const t=S();r.periodStartTs=t,r.paused=!1,r.gameStartTs||(r.gameStartTs=t),r.players.forEach(e=>{e.onField&&!e.stintStart&&(e.stintStart=t)}),E(),M(),G()}n.gStart.onclick=ae;n.gPause.onclick=ie;n.gHalf.onclick=be;n.gSave.onclick=()=>n.btnSave.click();function M(){T();const t=me(),e=r.gameLengthSec+j();n.clockLabel.textContent=`${g(t)} / ${g(e)}`,n.statusLabel.textContent=r.paused?"PAUSED":"RUNNING";const o=ee(r.currentPeriodIndex+1,r.periodCount);if(n.periodPill.textContent=`${o} (${r.currentPeriodIndex+1}/${r.periodCount})`,n.metaPill.textContent=`Stoppage ${g(j())} • Adjust ${z(N())}`,r.breakActive)if(r.halftimeEndTs&&S()<=r.halftimeEndTs){const i=Math.max(0,r.halftimeEndTs-S());n.halfLabel.style.display="",n.halfLabel.textContent=`BREAK ${g(i)}`}else n.halfLabel.style.display="",n.halfLabel.textContent="BREAK";else n.halfLabel.style.display="none";if(r.scheduledStartTs&&!r.gameStartTs){const i=r.scheduledStartTs-S();if(i>0)n.schedLabel.style.display="",n.schedLabel.textContent=`Starts in ${g(i)}`;else if(n.schedLabel.style.display="",n.schedLabel.textContent="Starting…",!window._gameStartAttempted){if(window._gameStartAttempted=!0,!r.roster||Object.keys(r.roster).length===0){console.warn("Scheduled start cancelled: No players in roster"),n.schedLabel.textContent="Cannot start: Add players first",n.schedLabel.style.color="red",r.scheduledStartTs=null,E(),window._gameStartAttempted=!1;return}ae(),setTimeout(()=>{window._gameStartAttempted=!1},2e3)}}else n.schedLabel.style.display="none";n.periodTable.innerHTML="";const s=S();for(let i=0;i<r.periodCount;i++){const d=i===r.currentPeriodIndex&&r.periodStartTs&&!r.paused&&!r.breakActive?Math.max(0,s-r.periodStartTs):0,p=(r.periodElapsed[i]||0)+d,c=r.periodAdjust[i]||0,u=r.periodStoppage[i]||0,m=ze(i),y=document.createElement("tr");i===r.currentPeriodIndex&&!r.breakActive&&(y.style.fontWeight="600"),y.innerHTML=`
      <td>${ee(i+1,r.periodCount)}</td>
      <td>${g(Ue(i))}</td>
      <td>${g(p)}</td>
      <td>${z(c)}</td>
      <td>${g(u)}</td>
      <td>${g(m)}</td>
    `,n.periodTable.appendChild(y)}n.onFieldTable.innerHTML="";const a={GK:0,DF:1,MF:2,ST:3};r.players.filter(i=>i.onField).sort((i,d)=>a[i.position||"Z"]-a[d.position||"Z"]||(i.number||"").localeCompare(d.number||"")||i.name.localeCompare(d.name)).forEach(i=>{const d=q(i),p=K(i),c=document.createElement("tr");c.onclick=()=>{v=i.name,ne()},c.style.cursor="pointer",v===i.name&&(c.className="selected-out"),c.innerHTML=`
      <td>${i.position||"-"}</td>
      <td>${i.name}</td>
      <td>${i.number||""}</td>
      <td>${g(d)}</td>
      <td><span class="fair ${te(p)}">${g(p)}</span></td>
      <td>${(i.preferred||"").toUpperCase()}</td>`,n.onFieldTable.appendChild(c)}),n.rosterGameTable.innerHTML="",r.players.slice().sort((i,d)=>(i.onField===d.onField?0:i.onField?-1:1)||(i.number||"").localeCompare(d.number||"")||i.name.localeCompare(d.name)).forEach(i=>{const d=q(i),p=K(i),c=document.createElement("tr");c.onclick=()=>{P=i.name,ne()},c.style.cursor="pointer",P===i.name&&(c.className="selected-in"),c.innerHTML=`
        <td>${i.name}</td>
        <td>${i.number||""}</td>
        <td>${i.onField?'<span class="pill status-in">IN</span>':'<span class="pill status-out">OUT</span>'}</td>
        <td>${i.position||"-"}</td>
        <td>${g(d)}</td>
        <td><span class="fair ${te(p)}">${g(p)}</span></td>
        <td>${(i.preferred||"").toUpperCase()}</td>`,n.rosterGameTable.appendChild(c)}),n.queueList.innerHTML="",_.forEach((i,d)=>{const p=r.players.find($=>$.name===i.out),c=r.players.find($=>$.name===i.in),u=(p==null?void 0:p.position)||"?",m=(p==null?void 0:p.number)||"",y=(c==null?void 0:c.number)||"",x=document.createElement("div");x.className="queue-item",x.innerHTML=`
      <div class="row" style="flex:1;align-items:center;">
        <span class="player-out">${i.out} #${m}</span>
        <span class="position-badge">${u}</span>
        <span class="sub-arrow">➜</span>
        <span class="player-in">${i.in} #${y}</span>
        ${c!=null&&c.onField?'<span class="pill" style="background:var(--warn);color:#1b1400;margin-left:8px;">Position Swap</span>':""}
      </div>
      <button class="btn" onclick="removeQueue(${d})">✕ Remove</button>
    `,n.queueList.appendChild(x)}),Q()}function ne(){const t=document.getElementById("selectionStatus"),e=document.getElementById("outPlayerDisplay"),o=document.getElementById("inPlayerDisplay");if(v||P){if(t.style.display="block",v){const s=r.players.find(i=>i.name===v),a=(s==null?void 0:s.number)||"",l=(s==null?void 0:s.position)||"?";e.innerHTML=`${v} #${a} <span class="position-badge">${l}</span>`}else e.textContent='Click player in "On Field" table';if(P){const s=r.players.find(i=>i.name===P),a=(s==null?void 0:s.number)||"",l=s!=null&&s.onField?" (currently on field - will swap positions)":"";o.innerHTML=`${P} #${a}${l}`}else o.textContent='Click player in "Roster" table'}else t.style.display="none";M()}n.btnQueue.onclick=()=>{if(!v){alert("⚠️ Please select a player from the 'On Field' table to substitute OUT.");return}if(!P){alert("⚠️ Please select a player from the 'Roster' table to substitute IN.");return}if(v===P){alert("⚠️ Cannot substitute a player for themselves. Please select different players.");return}const t=r.players.find(s=>s.name===v),e=r.players.find(s=>s.name===P),o=e.name+(e.onField?` (swap to ${t.position})`:"");_.push({out:v,in:P,_label:o}),v=null,P=null,ne()};n.btnClearQueue.onclick=()=>{_=[],M()};function Se(t){_.splice(t,1),M()}window.removeQueue=Se;n.btnCommit.onclick=()=>{if(!_.length){alert("No subs queued.");return}const t=S();_.forEach(e=>{const o=r.players.find(a=>a.name===e.out),s=r.players.find(a=>a.name===e.in);if(!(!o||!s||!o.onField||!o.position))if(s.onField){const a=o.position,l=s.position;o.position=l,s.position=a}else{const a=o.position;o.stintStart&&(o.totalSec+=t-o.stintStart),o.onField=!1,o.position=null,o.stintStart=null,s.onField=!0,s.position=a,s.stintStart=t}}),_=[],E(),M()};function G(){D||(D=setInterval(()=>{r.halftimeEndTs&&S()>=r.halftimeEndTs&&(r.halftimeEndTs=null,r.breakActive=!1,E(),alert("Halftime complete. Press Start/Resume to continue.")),M(),Q()},1e3))}function Xe(){D&&(clearInterval(D),D=null)}function Q(){if(!n.reportSummary)return;const t=fe();if(!t){n.reportSummary.textContent="Add players to view analytics.",n.reportDetail.textContent="",n.reportDistribution.textContent="",n.reportTargets.textContent="",n.reportElapsed.textContent="",n.reportTable.innerHTML="";return}const e=Math.round(t.elapsed),o=Math.round(t.totalTarget),s=Math.round(t.regulationSeconds),a=Math.round(t.stoppage),l=Math.round(t.adjustments),i=Math.max(0,o-e);n.reportSummary.textContent=`Elapsed ${g(e)} / Target ${g(o)} — ${t.rosterSize} players`,n.reportDetail.textContent=`Regulation ${g(s)} • Stoppage ${g(a)} • Adjust ${z(l)}`,n.reportTargets.textContent=`Per player target ${g(t.perPlayerRounded)}`,n.reportElapsed.textContent=`Remaining ${g(i)}`;const d=t.fairnessCounts||{under:0,ok:0,over:0},p=[`${d.under||0} under`,`${d.ok||0} on target`,`${d.over||0} over`];n.reportDistribution.textContent=`Average ${g(Math.round(t.average))} • Median ${g(Math.round(t.median))} • Range ${g(Math.round(t.min))}–${g(Math.round(t.max))} • Fairness ${p.join(" / ")}`,n.reportTable.innerHTML="",t.rows.forEach(c=>{const u=document.createElement("tr"),m=c.preferredDisplay||"—",y=`${c.targetSharePercent.toFixed(1)}%`;u.innerHTML=`
      <td>${c.name}</td>
      <td>${c.number}</td>
      <td>${m}</td>
      <td>${c.status}</td>
      <td><span class="fair ${c.fairness}">${g(Math.round(c.cumulativeSeconds))}</span></td>
      <td>${g(t.perPlayerRounded)}</td>
      <td><span class="fair ${c.fairness}">${z(Math.round(c.deltaSeconds))}</span></td>
      <td>${y}</td>
    `,n.reportTable.appendChild(u)})}function Ee(){if(r.scheduledStartTs){const t=new Date(r.scheduledStartTs*1e3),e=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0");n.scheduledLabel.textContent=`Scheduled for ${e}:${o}`}else n.scheduledLabel.textContent="";n.formatMinutes.value=Math.round(r.gameLengthSec/60),n.formatPeriods.value=String(r.periodCount),Ze()}function Ze(){T(),n.adjustPeriod.innerHTML="";for(let t=0;t<r.periodCount;t++){const e=document.createElement("option");e.value=String(t),e.textContent=ee(t+1,r.periodCount),n.adjustPeriod.appendChild(e)}r.periodCount>0&&!n.adjustPeriod.value&&(n.adjustPeriod.value="0"),typeof n.adjustKind.onchange=="function"&&n.adjustKind.onchange()}let b=null;function L(){n.playersTable&&fetch("/api/players").then(t=>t.json()).then(t=>{n.playersTable.innerHTML="",t.success&&Array.isArray(t.players)?t.players.forEach(e=>{const o=n.playersTable.insertRow();o.onclick=()=>et(e);let s="N/A";if(e.date_of_birth){const i=new Date(e.date_of_birth);s=Math.floor((new Date-i)/(365.25*24*60*60*1e3))}const a=e.preferred||"N/A",l=e.statistics?e.statistics.games_played:0;o.innerHTML=`
            <td>${e.name}</td>
            <td>${e.number||"N/A"}</td>
            <td>${s}</td>
            <td>${a}</td>
            <td>${l}</td>
            <td>
              <button onclick="event.stopPropagation(); editPlayerInline('${e.name}')">Edit</button>
              <button onclick="event.stopPropagation(); deletePlayerInline('${e.name}')">Delete</button>
            </td>
          `}):(console.warn("No players data received or API call failed:",t),n.playersTable.innerHTML='<tr><td colspan="6" style="text-align: center; color: #666;">No players found</td></tr>')}).catch(t=>{console.error("Error loading players:",t),alert("Error loading players: "+t.message)})}function et(t){b=t,n.playerDetails&&(n.playerDetails.innerHTML=`
      <h3>${t.name}</h3>
      <p><strong>Position:</strong> ${t.position}</p>
      <p><strong>Skill Level:</strong> ${t.skill_level}</p>
      ${t.contact_info?`
        <h4>Contact Information</h4>
        <p><strong>Phone:</strong> ${t.contact_info.phone||"N/A"}</p>
        <p><strong>Email:</strong> ${t.contact_info.email||"N/A"}</p>
        <p><strong>Emergency Contact:</strong> ${t.contact_info.emergency_contact||"N/A"}</p>
        <p><strong>Emergency Phone:</strong> ${t.contact_info.emergency_phone||"N/A"}</p>
      `:""}
      ${t.medical_info?`
        <h4>Medical Information</h4>
        <p><strong>Allergies:</strong> ${t.medical_info.allergies?t.medical_info.allergies.join(", "):"None"}</p>
        <p><strong>Medications:</strong> ${t.medical_info.medications?t.medical_info.medications.join(", "):"None"}</p>
        <p><strong>Medical Notes:</strong> ${t.medical_info.medical_notes||"None"}</p>
      `:""}
      ${t.stats?`
        <h4>Statistics</h4>
        <p><strong>Goals:</strong> ${t.stats.goals}</p>
        <p><strong>Assists:</strong> ${t.stats.assists}</p>
        <p><strong>Yellow Cards:</strong> ${t.stats.yellow_cards}</p>
        <p><strong>Red Cards:</strong> ${t.stats.red_cards}</p>
        <p><strong>Games Played:</strong> ${t.stats.games_played}</p>
        <p><strong>Total Minutes:</strong> ${t.stats.total_minutes}</p>
      `:""}
    `),n.btnEditPlayer&&(n.btnEditPlayer.disabled=!1),n.btnDeletePlayer&&(n.btnDeletePlayer.disabled=!1),n.btnPlayerStats&&(n.btnPlayerStats.disabled=!1),n.btnAttendance&&(n.btnAttendance.disabled=!1)}function tt(){const t=prompt("Enter player name:");if(!t)return;const e=prompt("Enter position (forward, midfielder, defender, goalkeeper):","midfielder");if(!e)return;const o=prompt("Enter skill level (1-10):","5");if(!o)return;const s={name:t,position:e,skill_level:parseInt(o)};fetch("/api/players",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}).then(a=>a.json()).then(()=>{L(),alert("Player added successfully!")}).catch(a=>{console.error("Error adding player:",a),alert("Error adding player: "+a.message)})}function nt(){if(!b){alert("Please select a player first.");return}const t=prompt("Edit player name:",b.name);if(t===null)return;const e=prompt("Edit position:",b.position);if(e===null)return;const o=prompt("Edit skill level (1-10):",b.skill_level.toString());if(o===null)return;const s={name:t,position:e,skill_level:parseInt(o)};fetch(`/api/players/${b.name}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}).then(a=>a.json()).then(()=>{L(),b=null,n.playerDetails.innerHTML="",alert("Player updated successfully!")}).catch(a=>{console.error("Error updating player:",a),alert("Error updating player: "+a.message)})}function ot(){if(!b){alert("Please select a player first.");return}confirm(`Are you sure you want to delete player ${b.name}?`)&&fetch(`/api/players/${b.name}`,{method:"DELETE"}).then(()=>{L(),b=null,n.playerDetails.innerHTML="",alert("Player deleted successfully!")}).catch(t=>{console.error("Error deleting player:",t),alert("Error deleting player: "+t.message)})}function st(t){fetch("/api/players").then(e=>e.json()).then(e=>{const o=e.players.find(l=>l.name===t);if(!o){alert("Player not found");return}const s=prompt("Edit player number:",o.number||"");if(s===null)return;const a=prompt("Edit preferred position(s):",o.preferred||"");a!==null&&fetch(`/api/players/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({number:s,preferred:a})}).then(l=>l.json()).then(()=>{L(),alert("Player updated successfully!")}).catch(l=>{console.error("Error updating player:",l),alert("Error updating player: "+l.message)})}).catch(e=>{console.error("Error fetching player:",e),alert("Error fetching player: "+e.message)})}function rt(t){confirm(`Are you sure you want to delete player ${t}?`)&&fetch(`/api/players/${t}`,{method:"DELETE"}).then(()=>{L(),alert("Player deleted successfully!")}).catch(e=>{console.error("Error deleting player:",e),alert("Error deleting player: "+e.message)})}function at(){const t=document.createElement("input");t.type="file",t.accept=".csv",t.onchange=function(e){const o=e.target.files[0];if(!o)return;const s=new FormData;s.append("file",o),fetch("/api/players/import",{method:"POST",body:s}).then(a=>a.json()).then(a=>{L(),alert(`Import completed! Added ${a.added} players, updated ${a.updated} players.`)}).catch(a=>{console.error("Error importing players:",a),alert("Error importing players: "+a.message)})},t.click()}function it(){fetch("/api/players/export").then(t=>t.blob()).then(t=>{const e=window.URL.createObjectURL(t),o=document.createElement("a");o.href=e,o.download="players.csv",o.click(),window.URL.revokeObjectURL(e)}).catch(t=>{console.error("Error exporting players:",t),alert("Error exporting players: "+t.message)})}function lt(){if(!b){alert("Please select a player first.");return}fetch(`/api/players/${b.name}/stats`).then(t=>t.json()).then(t=>{window.open("","_blank","width=600,height=400").document.write(`
        <html>
        <head><title>${b.name} - Statistics</title></head>
        <body>
          <h2>${b.name} - Statistics</h2>
          <table border="1" cellpadding="5">
            <tr><td><strong>Goals:</strong></td><td>${t.goals}</td></tr>
            <tr><td><strong>Assists:</strong></td><td>${t.assists}</td></tr>
            <tr><td><strong>Yellow Cards:</strong></td><td>${t.yellow_cards}</td></tr>
            <tr><td><strong>Red Cards:</strong></td><td>${t.red_cards}</td></tr>
            <tr><td><strong>Games Played:</strong></td><td>${t.games_played}</td></tr>
            <tr><td><strong>Total Minutes:</strong></td><td>${t.total_minutes}</td></tr>
            <tr><td><strong>Average Minutes/Game:</strong></td><td>${t.games_played>0?Math.round(t.total_minutes/t.games_played):0}</td></tr>
          </table>
          <button onclick="window.close()">Close</button>
        </body>
        </html>
      `)}).catch(t=>{console.error("Error loading player stats:",t),alert("Error loading player stats: "+t.message)})}function dt(){if(!b){alert("Please select a player first.");return}fetch(`/api/players/${b.name}/attendance`).then(t=>t.json()).then(t=>{const e=window.open("","_blank","width=600,height=400"),o=t.map(s=>`<tr>
          <td>${s.date}</td>
          <td>${s.present?"Present":"Absent"}</td>
          <td>${s.minutes_played||0}</td>
          <td>${s.notes||""}</td>
        </tr>`).join("");e.document.write(`
        <html>
        <head><title>${b.name} - Attendance</title></head>
        <body>
          <h2>${b.name} - Attendance</h2>
          <table border="1" cellpadding="5">
            <thead>
              <tr>
                <th>Date</th>
                <th>Status</th>
                <th>Minutes Played</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              ${o}
            </tbody>
          </table>
          <button onclick="window.close()">Close</button>
        </body>
        </html>
      `)}).catch(t=>{console.error("Error loading attendance:",t),alert("Error loading attendance: "+t.message)})}let f=null;async function O(){try{const e=await(await fetch("/api/formations")).json();if(e.success){const o=n.formationSelect;o.innerHTML='<option value="">-- Select Formation --</option>',e.formations.forEach(s=>{const a=document.createElement("option");a.value=s.name,a.textContent=s.name,o.appendChild(a)})}}catch(t){console.error("Failed to load formations:",t)}ct()}function ct(){const t=n.fieldMarkings;t.innerHTML=`
    <!-- Center line -->
    <div style="position:absolute; left:50%; top:10px; bottom:10px; width:2px; background:white; transform:translateX(-50%);"></div>
    <!-- Center circle -->
    <div style="position:absolute; left:50%; top:50%; width:60px; height:60px; border:2px solid white; border-radius:50%; transform:translate(-50%, -50%);"></div>
    <!-- Goals -->
    <div style="position:absolute; left:10px; top:45%; width:20px; height:10%; background:transparent; border:2px solid white; border-left:none;"></div>
    <div style="position:absolute; right:10px; top:45%; width:20px; height:10%; background:transparent; border:2px solid white; border-right:none;"></div>
  `}async function le(){const t=n.formationSelect.value;if(!t){Te();return}try{const o=await(await fetch(`/api/formations/${encodeURIComponent(t)}`)).json();o.success&&(f=o.formation,V(f))}catch(e){console.error("Failed to load formation:",e)}}function V(t){n.formationName.value=t.name||"",n.formationType.value=t.formation_type||"4-4-2",n.formationDescription.value=t.description||"",xe(t);const e=pt(t),o=r.fieldSize||11,s=e.total>=o?`${e.def}-${e.mid}-${e.for}`:`Incomplete (${e.total}/${o})`;n.formationInfo.textContent=`${t.name}: ${s}`,mt(t)}function xe(t){const e=n.formationPositions;e.innerHTML="",t.positions&&t.positions.forEach((o,s)=>{var d;const a=document.createElement("div"),l=o.x/100*(e.offsetWidth-20)+10,i=o.y/100*(e.offsetHeight-20)+10;a.style.cssText=`
      position: absolute;
      left: ${l}px;
      top: ${i}px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: ${ut(o.position_code)};
      border: 2px solid black;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-weight: bold;
      color: white;
      transform: translate(-50%, -50%);
    `,o.player_name?(a.textContent=o.player_number||o.player_name.slice(0,2),a.title=o.player_name):(a.textContent=((d=o.position_code)==null?void 0:d.slice(0,2))||"P",a.title=o.position_code||"Position"),e.appendChild(a)})}function ut(t){if(!t)return"gray";const e=t.toUpperCase();return e.includes("GK")||e.includes("GOALKEEPER")?"green":e.includes("DEF")||e.includes("DEFENDER")||e.includes("CB")||e.includes("LB")||e.includes("RB")?"blue":e.includes("MID")||e.includes("MIDFIELDER")||e.includes("CM")||e.includes("CDM")||e.includes("CAM")?"yellow":e.includes("FOR")||e.includes("FORWARD")||e.includes("ST")||e.includes("LW")||e.includes("RW")?"red":"gray"}function pt(t){if(!t.positions)return{total:0,gk:0,def:0,mid:0,for:0};let e=0,o=0,s=0,a=0;return t.positions.forEach(l=>{if(!l.position_code)return;const i=l.position_code.toUpperCase();i.includes("GK")||i.includes("GOALKEEPER")?e++:i.includes("DEF")||i.includes("DEFENDER")||i.includes("CB")||i.includes("LB")||i.includes("RB")?o++:i.includes("MID")||i.includes("MIDFIELDER")||i.includes("CM")||i.includes("CDM")||i.includes("CAM")?s++:(i.includes("FOR")||i.includes("FORWARD")||i.includes("ST")||i.includes("LW")||i.includes("RW"))&&a++}),{total:e+o+s+a,gk:e,def:o,mid:s,for:a}}function mt(t){const e=n.positionAssignments;if(e.innerHTML="",!t.positions){e.innerHTML='<div class="hint">No positions defined</div>';return}t.positions.forEach((o,s)=>{const a=document.createElement("div");a.className="row",a.style.marginBottom="8px";const l=document.createElement("div");l.style.minWidth="60px",l.textContent=`${s+1}. ${o.position_code||"POS"}`;const i=document.createElement("select");i.style.flex="1",i.innerHTML='<option value="">-- Unassigned --</option>',r.roster.forEach(d=>{const p=document.createElement("option");p.value=d.name,p.textContent=`${d.name} (${d.number||"N/A"})`,o.player_name===d.name&&(p.selected=!0),i.appendChild(p)}),i.onchange=()=>ft(s,i.value),a.appendChild(l),a.appendChild(i),e.appendChild(a)})}async function ft(t,e){if(f)try{const o={};o[t]=e;const a=await(await fetch(`/api/formations/${encodeURIComponent(f.name)}/assign`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({assignments:o})})).json();a.success&&(f=a.formation,xe(f))}catch(o){console.error("Failed to update assignment:",o)}}async function yt(){const t=prompt("Formation name:");if(!t)return;const e=n.formationType.value||"4-4-2",o=prompt("Description (optional):")||"";try{const s=gt(e),l=await(await fetch("/api/formations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,formation_type:e,description:o,positions:s})})).json();l.success?(await O(),n.formationSelect.value=t,await le(),alert("Formation created successfully!")):alert("Error: "+l.error)}catch(s){console.error("Failed to create formation:",s),alert("Failed to create formation")}}function gt(t){const e=[];switch(e.push({x:5,y:50,position_code:"GK"}),t){case"4-4-2":e.push({x:25,y:20,position_code:"LB"}),e.push({x:20,y:35,position_code:"CB"}),e.push({x:20,y:65,position_code:"CB"}),e.push({x:25,y:80,position_code:"RB"}),e.push({x:55,y:20,position_code:"LM"}),e.push({x:50,y:40,position_code:"CM"}),e.push({x:50,y:60,position_code:"CM"}),e.push({x:55,y:80,position_code:"RM"}),e.push({x:80,y:40,position_code:"ST"}),e.push({x:80,y:60,position_code:"ST"});break;case"4-3-3":e.push({x:25,y:20,position_code:"LB"}),e.push({x:20,y:35,position_code:"CB"}),e.push({x:20,y:65,position_code:"CB"}),e.push({x:25,y:80,position_code:"RB"}),e.push({x:50,y:30,position_code:"CM"}),e.push({x:45,y:50,position_code:"CM"}),e.push({x:50,y:70,position_code:"CM"}),e.push({x:80,y:25,position_code:"LW"}),e.push({x:85,y:50,position_code:"ST"}),e.push({x:80,y:75,position_code:"RW"});break;case"3-5-2":e.push({x:20,y:30,position_code:"CB"}),e.push({x:18,y:50,position_code:"CB"}),e.push({x:20,y:70,position_code:"CB"}),e.push({x:50,y:15,position_code:"LM"}),e.push({x:45,y:35,position_code:"CM"}),e.push({x:48,y:50,position_code:"CM"}),e.push({x:45,y:65,position_code:"CM"}),e.push({x:50,y:85,position_code:"RM"}),e.push({x:80,y:40,position_code:"ST"}),e.push({x:80,y:60,position_code:"ST"});break;case"4-5-1":e.push({x:25,y:20,position_code:"LB"}),e.push({x:20,y:35,position_code:"CB"}),e.push({x:20,y:65,position_code:"CB"}),e.push({x:25,y:80,position_code:"RB"}),e.push({x:55,y:15,position_code:"LM"}),e.push({x:50,y:30,position_code:"CM"}),e.push({x:48,y:50,position_code:"CM"}),e.push({x:50,y:70,position_code:"CM"}),e.push({x:55,y:85,position_code:"RM"}),e.push({x:85,y:50,position_code:"ST"});break;case"3-4-3":e.push({x:20,y:30,position_code:"CB"}),e.push({x:18,y:50,position_code:"CB"}),e.push({x:20,y:70,position_code:"CB"}),e.push({x:50,y:25,position_code:"LM"}),e.push({x:48,y:40,position_code:"CM"}),e.push({x:48,y:60,position_code:"CM"}),e.push({x:50,y:75,position_code:"RM"}),e.push({x:80,y:25,position_code:"LW"}),e.push({x:85,y:50,position_code:"ST"}),e.push({x:80,y:75,position_code:"RW"});break;case"5-3-2":e.push({x:28,y:15,position_code:"LB"}),e.push({x:22,y:30,position_code:"CB"}),e.push({x:20,y:50,position_code:"CB"}),e.push({x:22,y:70,position_code:"CB"}),e.push({x:28,y:85,position_code:"RB"}),e.push({x:55,y:30,position_code:"CM"}),e.push({x:52,y:50,position_code:"CM"}),e.push({x:55,y:70,position_code:"CM"}),e.push({x:82,y:40,position_code:"ST"}),e.push({x:82,y:60,position_code:"ST"});break;case"2-3-1":e.push({x:22,y:35,position_code:"CB"}),e.push({x:22,y:65,position_code:"CB"}),e.push({x:50,y:25,position_code:"LM"}),e.push({x:48,y:50,position_code:"CM"}),e.push({x:50,y:75,position_code:"RM"}),e.push({x:80,y:50,position_code:"ST"});break;case"3-2-1":e.push({x:22,y:25,position_code:"CB"}),e.push({x:20,y:50,position_code:"CB"}),e.push({x:22,y:75,position_code:"CB"}),e.push({x:50,y:35,position_code:"CM"}),e.push({x:50,y:65,position_code:"CM"}),e.push({x:80,y:50,position_code:"ST"});break;case"3-3-2":e.push({x:22,y:25,position_code:"CB"}),e.push({x:20,y:50,position_code:"CB"}),e.push({x:22,y:75,position_code:"CB"}),e.push({x:50,y:25,position_code:"LM"}),e.push({x:48,y:50,position_code:"CM"}),e.push({x:50,y:75,position_code:"RM"}),e.push({x:78,y:40,position_code:"ST"}),e.push({x:78,y:60,position_code:"ST"});break;case"3-2-3":e.push({x:22,y:25,position_code:"CB"}),e.push({x:20,y:50,position_code:"CB"}),e.push({x:22,y:75,position_code:"CB"}),e.push({x:48,y:35,position_code:"CM"}),e.push({x:48,y:65,position_code:"CM"}),e.push({x:78,y:25,position_code:"LW"}),e.push({x:82,y:50,position_code:"ST"}),e.push({x:78,y:75,position_code:"RW"});break;case"3-4-2":e.push({x:22,y:25,position_code:"CB"}),e.push({x:20,y:50,position_code:"CB"}),e.push({x:22,y:75,position_code:"CB"}),e.push({x:50,y:20,position_code:"LM"}),e.push({x:48,y:40,position_code:"CM"}),e.push({x:48,y:60,position_code:"CM"}),e.push({x:50,y:80,position_code:"RM"}),e.push({x:78,y:40,position_code:"ST"}),e.push({x:78,y:60,position_code:"ST"});break;case"4-3-2":e.push({x:25,y:20,position_code:"LB"}),e.push({x:20,y:40,position_code:"CB"}),e.push({x:20,y:60,position_code:"CB"}),e.push({x:25,y:80,position_code:"RB"}),e.push({x:50,y:30,position_code:"CM"}),e.push({x:48,y:50,position_code:"CM"}),e.push({x:50,y:70,position_code:"CM"}),e.push({x:78,y:40,position_code:"ST"}),e.push({x:78,y:60,position_code:"ST"});break;default:const o=r.fieldSize||11;for(let s=1;s<o;s++)e.push({x:s%3*30+25,y:Math.floor(s/3)*20+30,position_code:"MID"})}return e}async function ht(){try{const e=await(await fetch("/api/formations/templates")).json();if(e.success&&e.templates.length>0){const o=n.templateList;o.innerHTML="",e.templates.forEach((s,a)=>{const l=document.createElement("div");l.className="panel",l.style.cssText="margin-bottom: 8px; cursor: pointer; border: 2px solid transparent;",l.innerHTML=`
          <strong>${s.name}</strong><br>
          <span class="hint">${s.description||"No description"}</span>
        `,l.onclick=()=>{o.querySelectorAll(".panel").forEach(i=>i.style.borderColor="transparent"),l.style.borderColor="var(--accent)",o.selectedTemplate=s},o.appendChild(l)}),n.templateModal.classList.remove("hidden")}else alert("No formation templates available")}catch(t){console.error("Failed to load templates:",t),alert("Failed to load templates")}}async function bt(){const t=n.templateList.selectedTemplate,e=n.templateFormationName.value.trim();if(!t){alert("Please select a template");return}if(!e){alert("Please enter a formation name");return}try{const s=await(await fetch("/api/formations/from-template",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({template_type:t.formation_type,name:e})})).json();s.success?(n.templateModal.classList.add("hidden"),n.templateFormationName.value="",await O(),n.formationSelect.value=e,await le(),alert("Formation created from template!")):alert("Error: "+s.error)}catch(o){console.error("Failed to create from template:",o),alert("Failed to create formation from template")}}async function St(){if(!f){alert("No formation selected");return}if(confirm(`Delete formation "${f.name}"?`))try{const e=await(await fetch(`/api/formations/${encodeURIComponent(f.name)}`,{method:"DELETE"})).json();e.success?(f=null,Te(),await O(),alert("Formation deleted")):alert("Error: "+e.error)}catch(t){console.error("Failed to delete formation:",t),alert("Failed to delete formation")}}async function Et(){if(!f){alert("No formation selected");return}if(f.name=n.formationName.value.trim(),f.formation_type=n.formationType.value,f.description=n.formationDescription.value.trim(),!f.name){alert("Formation name is required");return}try{alert("Formation saved! (Note: Full save functionality requires backend implementation)")}catch(t){console.error("Failed to save formation:",t),alert("Failed to save formation")}}async function xt(){if(!f){alert("No formation selected");return}try{const t={},e=[...r.roster];f.positions.forEach((a,l)=>{if(e.length>0){const i=e.shift();t[l]=i.name}});const s=await(await fetch(`/api/formations/${encodeURIComponent(f.name)}/assign`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({assignments:t})})).json();s.success&&(f=s.formation,V(f),alert("Players auto-assigned!"))}catch(t){console.error("Failed to auto-assign:",t),alert("Failed to auto-assign players")}}async function Tt(){if(!f){alert("No formation selected");return}try{const e=await(await fetch(`/api/formations/${encodeURIComponent(f.name)}/assign`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({assignments:{}})})).json();e.success&&(f=e.formation,V(f),alert("All assignments cleared!"))}catch(t){console.error("Failed to clear assignments:",t),alert("Failed to clear assignments")}}async function Ct(){try{const e=await(await fetch("/api/formations/suggest",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})})).json();e.success?(f=e.formation,V(f),alert(`Suggested formation: ${e.formation.name}
Based on your current roster.`)):alert("Error: "+e.error)}catch(t){console.error("Failed to suggest formation:",t),alert("Failed to suggest formation")}}function Te(){n.formationName.value="",n.formationType.value="4-4-2",n.formationDescription.value="",n.formationPositions.innerHTML="",n.formationInfo.textContent="No formation selected",n.positionAssignments.innerHTML='<div class="hint">Select a formation to assign players</div>'}function H(){Ee(),ye(),M(),Q(),L(),O()}function Mt(){console.log("[DEBUG] Starting initialization..."),qe(),console.log("[DEBUG] Local state loaded"),H(),console.log("[DEBUG] All views rendered"),F("setup"),console.log("[DEBUG] Showing setup view"),G(),console.log("[DEBUG] Application fully initialized and ready!")}window.apiAddStoppageTime=Ae;window.apiAddTimeAdjustment=Be;window.exportReportCSV=ke;window.removeQueue=Se;window.editPlayerInline=st;window.deletePlayerInline=rt;document.addEventListener("DOMContentLoaded",()=>{Mt()});
